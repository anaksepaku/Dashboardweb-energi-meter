<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Power Monitor - Ruang Kebon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --card-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            padding: 25px 30px;
            background: linear-gradient(to right, var(--dark), #34495e);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header-left h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-left p {
            color: var(--light);
            font-size: 0.9rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .refresh-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.85rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            padding: 30px;
        }
        
        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .status-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
        }
        
        .status-card h3 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-card h3 i {
            color: var(--primary);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-badge {
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-online {
            background-color: rgba(46, 204, 113, 0.15);
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .status-offline {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .connection-online {
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        .connection-offline {
            background-color: var(--danger);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-item {
            background-color: var(--light);
            padding: 12px 15px;
            border-radius: 10px;
        }
        
        .info-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .info-value {
            font-weight: 600;
            color: var(--dark);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .metric-card h4 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .metric-unit {
            font-size: 0.9rem;
            color: var(--gray);
            font-weight: 500;
        }
        
        .metric-change {
            font-size: 0.8rem;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 50px;
            display: inline-block;
        }
        
        .change-up {
            background-color: rgba(46, 204, 113, 0.15);
            color: var(--success);
        }
        
        .change-down {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 900px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chart-card h3 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .data-table {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .data-table h3 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: var(--light);
            color: var(--dark);
            font-weight: 600;
            padding: 15px;
            text-align: left;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid var(--light);
            color: var(--dark);
        }
        
        tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .warning-box {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 5px solid var(--warning);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .warning-box h4 {
            color: var(--warning);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .warning-box p {
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-success {
            background-color: var(--success);
        }
        
        .notification-error {
            background-color: var(--danger);
        }
        
        .notification-info {
            background-color: var(--primary);
        }
        
        .sidebar {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            height: fit-content;
        }
        
        .sidebar h3 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .system-stats {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--light);
            border-radius: 10px;
        }
        
        .stat-label {
            color: var(--dark);
            font-weight: 500;
        }
        
        .stat-value {
            font-weight: 700;
            color: var(--dark);
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .history-item {
            background-color: var(--light);
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-time {
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        .history-value {
            font-weight: 600;
            color: var(--dark);
        }
        
        .no-data {
            text-align: center;
            padding: 30px;
            color: var(--gray);
        }
        
        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--light);
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid var(--light);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-bolt"></i> Power Monitor - Ruang Kebon</h1>
                <p>Monitoring Konsumsi Daya Listrik Real-time</p>
            </div>
            <div class="header-right">
                <div class="refresh-info">
                    <i class="fas fa-sync-alt"></i> Auto-refresh: <span id="refreshTimer">2</span>s
                </div>
                <a href="index.html" class="back-button">
                    <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
                </a>
            </div>
        </div>
        
        <div class="main-content">
            <div class="main-panel">
                <div class="status-card">
                    <h3><i class="fas fa-server"></i> Status Perangkat Power Monitor</h3>
                    <div class="status-indicator">
                        <div id="status" class="status-badge status-offline">
                            <span class="connection-status connection-offline"></span>
                            OFFLINE - Menunggu koneksi
                        </div>
                        <div id="syncStatus" class="status-badge" style="display: none;">
                            <i class="fas fa-sync"></i> Menunggu data sensor...
                        </div>
                    </div>
                    
                    <div class="device-info">
                        <div class="info-item">
                            <div class="info-label">Device ID</div>
                            <div class="info-value" id="deviceId">ESP32_5447A11F8A3C</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Terakhir Update</div>
                            <div class="info-value" id="lastSeen">--</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Durasi Koneksi</div>
                            <div class="info-value" id="connectionTime">--</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Data Points</div>
                            <div class="info-value" id="dataPoints">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card" style="border-top-color: #3498db;">
                        <h4><i class="fas fa-bolt"></i> Voltage</h4>
                        <div class="metric-value" id="voltage">--</div>
                        <div class="metric-unit">Volt (V)</div>
                        <div id="voltageChange" class="metric-change">--</div>
                    </div>
                    
                    <div class="metric-card" style="border-top-color: #2ecc71;">
                        <h4><i class="fas fa-tachometer-alt"></i> Current</h4>
                        <div class="metric-value" id="current">--</div>
                        <div class="metric-unit">Ampere (A)</div>
                        <div id="currentChange" class="metric-change">--</div>
                    </div>
                    
                    <div class="metric-card" style="border-top-color: #e74c3c;">
                        <h4><i class="fas fa-charging-station"></i> Power</h4>
                        <div class="metric-value" id="power">--</div>
                        <div class="metric-unit">Watt (W)</div>
                        <div id="powerChange" class="metric-change">--</div>
                    </div>
                    
                    <div class="metric-card" style="border-top-color: #f39c12;">
                        <h4><i class="fas fa-battery-full"></i> Energy</h4>
                        <div class="metric-value" id="energy">--</div>
                        <div class="metric-unit">kWh</div>
                        <div id="energyChange" class="metric-change">--</div>
                    </div>
                    
                    <div class="metric-card" style="border-top-color: #9b59b6;">
                        <h4><i class="fas fa-wave-square"></i> Frequency</h4>
                        <div class="metric-value" id="frequency">--</div>
                        <div class="metric-unit">Hertz (Hz)</div>
                        <div id="frequencyChange" class="metric-change">--</div>
                    </div>
                    
                    <div class="metric-card" style="border-top-color: #1abc9c;">
                        <h4><i class="fas fa-cog"></i> Power Factor</h4>
                        <div class="metric-value" id="powerFactor">--</div>
                        <div class="metric-unit">Factor</div>
                        <div id="powerFactorChange" class="metric-change">--</div>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h3><i class="fas fa-chart-line"></i> Power Consumption (30m)</h3>
                        <div class="chart-container">
                            <canvas id="powerChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3><i class="fas fa-chart-area"></i> Voltage & Current</h3>
                        <div class="chart-container">
                            <canvas id="voltageCurrentChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="loadData()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <button class="btn btn-success" onclick="startAutoRefresh()">
                        <i class="fas fa-play"></i> Start Auto Refresh
                    </button>
                    <button class="btn btn-warning" onclick="stopAutoRefresh()">
                        <i class="fas fa-pause"></i> Stop Auto Refresh
                    </button>
                    <button class="btn btn-danger" onclick="resetData()">
                        <i class="fas fa-trash"></i> Reset Data
                    </button>
                </div>
                
                <div class="data-table">
                    <h3><i class="fas fa-history"></i> Riwayat 20 Pembacaan Terakhir</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Waktu</th>
                                    <th>Device ID</th>
                                    <th>Voltage (V)</th>
                                    <th>Current (A)</th>
                                    <th>Power (W)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="6" class="no-data">
                                        <i class="fas fa-database"></i>
                                        <div>Belum ada data yang tersedia</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="warning-box">
                    <h4><i class="fas fa-exclamation-triangle"></i> Perhatian</h4>
                    <p>‚Ä¢ Dashboard hanya menampilkan data dari device: <strong>ESP32_5447A11F8A3C</strong></p>
                    <p>‚Ä¢ Status ONLINE hanya jika device tersebut aktif mengirim data dalam 15 detik terakhir</p>
                    <p>‚Ä¢ Device lain tidak akan ditampilkan di halaman ini</p>
                    <p>‚Ä¢ Data disimpan sebanyak 20 riwayat terakhir</p>
                </div>
            </div>
            
            <div class="sidebar">
                <h3><i class="fas fa-chart-bar"></i> System Stats</h3>
                <div class="system-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Updates</span>
                        <span class="stat-value" id="totalUpdates">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Uptime</span>
                        <span class="stat-value" id="uptime">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Refresh Interval</span>
                        <span class="stat-value">2 detik</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Data History</span>
                        <span class="stat-value">20 records</span>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;"><i class="fas fa-clock"></i> Recent Activity</h3>
                <div class="history-list" id="historyList">
                    <div class="history-item">
                        <div class="history-time">--:--:--</div>
                        <div class="history-value">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Power Monitoring System &copy; 2023 | Update Interval: 2 detik | History: 20 data points</p>
        </div>
    </div>

    <script>
        // Konfigurasi
        const TARGET_DEVICE_ID = "ESP32_5447A11F8A3C";
        const OFFLINE_THRESHOLD = 15000; // 15 detik tanpa update = offline
        const HISTORY_SIZE = 20; // Menyimpan 20 riwayat data terakhir
        const UPDATE_INTERVAL = 2000; // Interval update 2 detik
        
        // Variabel global
        let refreshInterval;
        let isPowerDeviceOnline = false;
        let lastPowerData = null;
        let lastSuccessfulUpdate = 0;
        let powerDataHistory = [];
        let chartDataHistory = [];
        let totalUpdates = 0;
        let startTime = Date.now();
        let previousValues = {};
        
        // Chart instances
        let powerChart;
        let voltageCurrentChart;
        
        // Inisialisasi chart
        function initializeCharts() {
            // Power Chart
            const powerCtx = document.getElementById('powerChart').getContext('2d');
            powerChart = new Chart(powerCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Power (W)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Waktu'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Power (W)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Voltage & Current Chart
            const voltageCurrentCtx = document.getElementById('voltageCurrentChart').getContext('2d');
            voltageCurrentChart = new Chart(voltageCurrentCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Voltage (V)',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Current (A)',
                            data: [],
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Waktu'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Voltage (V)'
                            },
                            beginAtZero: false
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Current (A)'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }
        
        // Update charts dengan data baru
        function updateCharts(data) {
            const now = new Date();
            const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + 
                            now.getMinutes().toString().padStart(2, '0') + ':' + 
                            now.getSeconds().toString().padStart(2, '0');
            
            // Simpan data untuk chart (maks 30 titik)
            chartDataHistory.push({
                time: timeLabel,
                voltage: data.voltage,
                current: data.current,
                power: data.power,
                energy: data.energy,
                frequency: data.frequency,
                powerFactor: data.power_factor
            });
            
            // Batasi jumlah data di chart
            if (chartDataHistory.length > 30) {
                chartDataHistory.shift();
            }
            
            // Update Power Chart
            powerChart.data.labels = chartDataHistory.map(d => d.time);
            powerChart.data.datasets[0].data = chartDataHistory.map(d => d.power);
            powerChart.update();
            
            // Update Voltage & Current Chart
            voltageCurrentChart.data.labels = chartDataHistory.map(d => d.time);
            voltageCurrentChart.data.datasets[0].data = chartDataHistory.map(d => d.voltage);
            voltageCurrentChart.data.datasets[1].data = chartDataHistory.map(d => d.current);
            voltageCurrentChart.update();
        }
        
        // Fungsi utama untuk memuat data
        function loadData() {
            fetch("/api/status/all")
                .then((response) => response.json())
                .then((data) => {
                    console.log("üìä All Status Data:", data);
                    processPowerData(data);
                    checkConnectionTimeout();
                })
                .catch((error) => {
                    console.error("Error fetching status:", error);
                    setOfflineStatus();
                });
        }
        
        // Proses data power
        function processPowerData(data) {
            const powerSensor = data.sensors.power;
            console.log("üîß Power Sensor Data:", powerSensor);
            
            // Cek apakah data power valid dan fresh dari device yang ditarget
            const isDataFresh = isPowerDataFresh(powerSensor);
            const targetDevice = findTargetDevice(data);
            
            if (isDataFresh && targetDevice && powerSensor.data && Object.keys(powerSensor.data).length > 0) {
                // Device target online dengan data fresh
                isPowerDeviceOnline = true;
                lastSuccessfulUpdate = Date.now();
                
                updateDeviceStatus({
                    isOnline: true,
                    lastSeen: powerSensor.lastUpdate,
                    deviceId: targetDevice.deviceId
                });

                lastPowerData = powerSensor.data;
                updateDisplayFromESP32(powerSensor.data);
                checkSyncStatus(powerSensor.data);
                updateCharts(powerSensor.data);
                
                // Simpan ke history
                saveToHistory(powerSensor.data);
                
            } else {
                // Device target tidak online atau data tidak fresh
                isPowerDeviceOnline = false;
                setOfflineStatus();
            }

            loadHistory();
            updateSystemStats();
        }
        
        // Cari device spesifik ESP32_5447A11F8A3C
        function findTargetDevice(data) {
            let targetDevice = null;
            
            Object.keys(data.sensors).forEach(sensorType => {
                const sensor = data.sensors[sensorType];
                if (sensor.data && sensor.data.deviceId) {
                    const deviceId = sensor.data.deviceId;
                    if (deviceId === TARGET_DEVICE_ID) {
                        targetDevice = {
                            deviceId: deviceId,
                            sensorType: sensorType,
                            lastUpdate: sensor.lastUpdate
                        };
                        console.log("üéØ Target device found:", targetDevice);
                    }
                }
            });
            
            return targetDevice;
        }
        
        // Cek kesegaran data power
        function isPowerDataFresh(powerSensor) {
            if (!powerSensor || !powerSensor.lastUpdate) return false;
            
            const lastUpdate = new Date(powerSensor.lastUpdate).getTime();
            const now = Date.now();
            const dataAge = now - lastUpdate;
            
            console.log(`üïí Power Data age: ${dataAge}ms`);
            
            // Data dianggap fresh jika kurang dari 10 detik
            return dataAge < 10000;
        }
        
        // Cek timeout koneksi
        function checkConnectionTimeout() {
            const now = Date.now();
            if (lastSuccessfulUpdate > 0 && (now - lastSuccessfulUpdate) > OFFLINE_THRESHOLD) {
                console.log("üïí Power connection timeout detected");
                setOfflineStatus();
            }
        }
        
        // Update device status
        function updateDeviceStatus(status) {
            const statusElement = document.getElementById("status");
            const lastSeenElement = document.getElementById("lastSeen");
            const deviceInfoElement = document.getElementById("deviceId");
            const connectionTimeElement = document.getElementById("connectionTime");
            const syncElement = document.getElementById("syncStatus");
            
            if (status.isOnline && isPowerDeviceOnline) {
                statusElement.className = "status-badge status-online";
                statusElement.innerHTML = `<span class="connection-status connection-online"></span> ONLINE - Terhubung ke Power Monitor`;
                
                if (status.lastSeen) {
                    const lastSeen = new Date(status.lastSeen);
                    const now = new Date();
                    const diffSeconds = Math.round((now - lastSeen) / 1000);
                    lastSeenElement.textContent = `${lastSeen.toLocaleTimeString()} (${diffSeconds} detik lalu)`;
                    
                    // Hitung waktu koneksi
                    const connectionDuration = Math.round((now - lastSeen) / 1000);
                    const hours = Math.floor(connectionDuration / 3600);
                    const minutes = Math.floor((connectionDuration % 3600) / 60);
                    const seconds = connectionDuration % 60;
                    
                    if (hours > 0) {
                        connectionTimeElement.textContent = `${hours}j ${minutes}m ${seconds}d`;
                    } else if (minutes > 0) {
                        connectionTimeElement.textContent = `${minutes}m ${seconds}d`;
                    } else {
                        connectionTimeElement.textContent = `${seconds} detik`;
                    }
                }

                if (status.deviceId) {
                    deviceInfoElement.textContent = `${status.deviceId}`;
                }

                syncElement.style.display = "inline-flex";
                syncElement.innerHTML = `<i class="fas fa-sync"></i> Data tersinkronisasi`;
                syncElement.className = "status-badge status-online";
                
            } else {
                setOfflineStatus();
            }
        }
        
        // Set status offline
        function setOfflineStatus() {
            const statusElement = document.getElementById("status");
            const lastSeenElement = document.getElementById("lastSeen");
            const connectionTimeElement = document.getElementById("connectionTime");
            const syncElement = document.getElementById("syncStatus");
            
            isPowerDeviceOnline = false;
            lastSuccessfulUpdate = 0;

            statusElement.className = "status-badge status-offline";
            statusElement.innerHTML = `<span class="connection-status connection-offline"></span> OFFLINE - Power Monitor tidak terhubung`;
            
            lastSeenElement.textContent = "--";
            connectionTimeElement.textContent = "--";
            
            syncElement.style.display = "inline-flex";
            syncElement.className = "status-badge status-offline";
            syncElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Menunggu data sensor`;
            
            resetDisplayValues();
        }
        
        // Reset display values
        function resetDisplayValues() {
            document.getElementById("voltage").textContent = '--';
            document.getElementById("current").textContent = '--';
            document.getElementById("power").textContent = '--';
            document.getElementById("energy").textContent = '--';
            document.getElementById("frequency").textContent = '--';
            document.getElementById("powerFactor").textContent = '--';
            
            // Reset change indicators
            document.getElementById("voltageChange").textContent = '--';
            document.getElementById("currentChange").textContent = '--';
            document.getElementById("powerChange").textContent = '--';
            document.getElementById("energyChange").textContent = '--';
            document.getElementById("frequencyChange").textContent = '--';
            document.getElementById("powerFactorChange").textContent = '--';
        }
        
        // Update display dari data ESP32
        function updateDisplayFromESP32(data) {
            console.log("üîÑ Update Power Display from ESP32:", data);
            
            // Update nilai dan hitung perubahan
            updateMetric('voltage', data.voltage, 'V');
            updateMetric('current', data.current, 'A');
            updateMetric('power', data.power, 'W');
            updateMetric('energy', data.energy, 'kWh');
            updateMetric('frequency', data.frequency, 'Hz');
            updateMetric('powerFactor', data.power_factor || 0, '');
            
            // Increment total updates
            totalUpdates++;
        }
        
        // Update metric dengan perbandingan perubahan
        function updateMetric(metricId, value, unit) {
            const element = document.getElementById(metricId);
            const changeElement = document.getElementById(metricId + 'Change');
            
            if (value !== undefined) {
                let formattedValue;
                if (metricId === 'voltage') formattedValue = value.toFixed(1);
                else if (metricId === 'current') formattedValue = value.toFixed(3);
                else if (metricId === 'power') formattedValue = value.toFixed(1);
                else if (metricId === 'energy') formattedValue = value.toFixed(3);
                else if (metricId === 'frequency') formattedValue = value.toFixed(1);
                else if (metricId === 'powerFactor') formattedValue = value.toFixed(2);
                else formattedValue = value;
                
                element.textContent = formattedValue;
                
                // Hitung perubahan
                if (previousValues[metricId] !== undefined) {
                    const change = value - previousValues[metricId];
                    const changePercent = (change / previousValues[metricId] * 100).toFixed(1);
                    
                    if (change > 0) {
                        changeElement.textContent = `‚Üë ${changePercent}%`;
                        changeElement.className = "metric-change change-up";
                    } else if (change < 0) {
                        changeElement.textContent = `‚Üì ${Math.abs(changePercent)}%`;
                        changeElement.className = "metric-change change-down";
                    } else {
                        changeElement.textContent = `‚Üí 0.0%`;
                        changeElement.className = "metric-change";
                    }
                } else {
                    changeElement.textContent = '--';
                }
                
                // Simpan nilai saat ini untuk perbandingan berikutnya
                previousValues[metricId] = value;
            }
        }
        
        // Cek status sinkronisasi
        function checkSyncStatus(data) {
            const syncElement = document.getElementById("syncStatus");
            
            if (data && data.voltage !== undefined) {
                syncElement.style.display = "inline-flex";
                syncElement.className = "status-badge status-online";
                syncElement.innerHTML = `<i class="fas fa-sync"></i> Data tersinkronisasi`;
            }
        }
        
        // Simpan data ke history (20 data terakhir)
        function saveToHistory(data) {
            const historyItem = {
                timestamp: new Date().toLocaleTimeString(),
                deviceId: data.deviceId || TARGET_DEVICE_ID,
                voltage: data.voltage?.toFixed(1) || "0.0",
                current: data.current?.toFixed(3) || "0.000",
                power: data.power?.toFixed(1) || "0.0",
                energy: data.energy?.toFixed(3) || "0.000",
                frequency: data.frequency?.toFixed(1) || "0.0",
                powerFactor: data.power_factor?.toFixed(2) || "0.00"
            };
            
            // Tambahkan ke array history
            powerDataHistory.push(historyItem);
            
            // Batasi hanya 20 data terakhir
            if (powerDataHistory.length > HISTORY_SIZE) {
                powerDataHistory.shift();
            }
            
            // Update data points count
            document.getElementById('dataPoints').textContent = powerDataHistory.length;
            
            // Update recent activity sidebar
            updateRecentActivity(historyItem);
        }
        
        // Update recent activity sidebar
        function updateRecentActivity(item) {
            const historyList = document.getElementById('historyList');
            
            // Buat elemen baru
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <div class="history-time">${item.timestamp}</div>
                <div class="history-value">${item.power} W</div>
            `;
            
            // Tambahkan di awal
            historyList.insertBefore(historyItem, historyList.firstChild);
            
            // Batasi hanya 5 item terbaru
            if (historyList.children.length > 5) {
                historyList.removeChild(historyList.lastChild);
            }
        }
        
        // Load history dari API
        function loadHistory() {
            fetch("/api/all/power")
                .then((response) => response.json())
                .then((data) => {
                    // Filter hanya data dari device target
                    const powerHistory = data.data.filter(item => 
                        item.deviceId && item.deviceId === TARGET_DEVICE_ID
                    );
                    
                    // Simpan data history (maks 20)
                    const recentHistory = powerHistory.slice(-HISTORY_SIZE);
                    powerDataHistory = recentHistory.map(item => ({
                        timestamp: item.timestamp || new Date().toLocaleTimeString(),
                        deviceId: item.deviceId,
                        voltage: item.voltage?.toFixed(1) || "0.0",
                        current: item.current?.toFixed(3) || "0.000",
                        power: item.power?.toFixed(1) || "0.0",
                        energy: item.energy?.toFixed(3) || "0.000",
                        frequency: item.frequency?.toFixed(1) || "0.0",
                        powerFactor: item.power_factor?.toFixed(2) || "0.00"
                    }));
                    
                    // Update table
                    updateTable(powerDataHistory.slice(-20));
                })
                .catch((error) => {
                    console.error("Error loading history:", error);
                });
        }
        
        // Update table dengan data history
        function updateTable(data) {
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #666; padding: 30px;">Belum ada riwayat data dari ${TARGET_DEVICE_ID}</td></tr>`;
                return;
            }

            // Tampilkan data terbaru di atas
            data.slice().reverse().forEach((item) => {
                const status = item.deviceId ? "‚úÖ Online" : "‚ùå Offline";
                const row = `<tr>
                    <td>${item.timestamp}</td>
                    <td>${item.deviceId || "Unknown"}</td>
                    <td>${item.voltage}</td>
                    <td>${item.current}</td>
                    <td>${item.power}</td>
                    <td>${status}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }
        
        // Update system stats
        function updateSystemStats() {
            document.getElementById('totalUpdates').textContent = totalUpdates;
            document.getElementById('dataPoints').textContent = powerDataHistory.length;
            
            // Hitung uptime
            const uptimeMs = Date.now() - startTime;
            const hours = Math.floor(uptimeMs / (1000 * 60 * 60));
            const minutes = Math.floor((uptimeMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((uptimeMs % (1000 * 60)) / 1000);
            
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Timer untuk refresh countdown
        let refreshCountdown = 2;
        function updateRefreshTimer() {
            const timerElement = document.getElementById('refreshTimer');
            refreshCountdown--;
            
            if (refreshCountdown <= 0) {
                refreshCountdown = 2; // Reset ke 2 detik
            }
            
            timerElement.textContent = refreshCountdown;
        }
        
        // Start auto refresh
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                loadData();
            }, UPDATE_INTERVAL);
            
            // Start countdown timer
            const timerInterval = setInterval(updateRefreshTimer, 1000);
            
            showNotification("Auto refresh ON (2 detik)", "success");
        }
        
        // Stop auto refresh
        function stopAutoRefresh() {
            clearInterval(refreshInterval);
            showNotification("Auto refresh OFF", "info");
            loadData(); // Update status terakhir
        }
        
        // Reset data
        function resetData() {
            if (confirm("Yakin ingin mereset semua data power?")) {
                fetch("/api/reset/power", { method: "DELETE" })
                    .then(() => {
                        powerDataHistory = [];
                        chartDataHistory = [];
                        totalUpdates = 0;
                        startTime = Date.now();
                        previousValues = {};
                        
                        if (powerChart && voltageCurrentChart) {
                            powerChart.data.labels = [];
                            powerChart.data.datasets[0].data = [];
                            powerChart.update();
                            
                            voltageCurrentChart.data.labels = [];
                            voltageCurrentChart.data.datasets[0].data = [];
                            voltageCurrentChart.data.datasets[1].data = [];
                            voltageCurrentChart.update();
                        }
                        
                        loadData();
                        showNotification("Data power berhasil direset!", "success");
                    })
                    .catch((error) => {
                        showNotification("Error resetting data: " + error, "error");
                    });
            }
        }
        
        // Show notification
        function showNotification(message, type) {
            // Hapus notifikasi sebelumnya jika ada
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement("div");
            notification.className = `notification notification-${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            
            notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Initialize charts and start auto refresh
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadData();
            startAutoRefresh();
            
            // Cek connection timeout setiap 5 detik
            setInterval(checkConnectionTimeout, 5000);
        });
        
        // Debug function
        window.debugPower = function() {
            console.log("üîß Debug Power Status:");
            console.log("- Target Device ID:", TARGET_DEVICE_ID);
            console.log("- Power Device Online:", isPowerDeviceOnline);
            console.log("- Last Data:", lastPowerData);
            console.log("- Last Successful Update:", lastSuccessfulUpdate);
            console.log("- Time Since Last Update:", Date.now() - lastSuccessfulUpdate);
            console.log("- Total Updates:", totalUpdates);
            console.log("- Data History:", powerDataHistory.length, "items");
            loadData();
        }
    </script>
</body>
</html>
